worker_processes  1;

error_log  /dev/stderr warn;
pid /tmp/pid;

events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    map $http_user_agent $excluded_ua {
        ~kube-probe  0;
        default      1;
    }


    log_format json escape=json '{ "time": "$time_iso8601", "remote_addr": "$proxy_protocol_addr",'
      '"x-forward-for": "$proxy_add_x_forwarded_for", "request_id": "$request", "remote_user": '
      '"$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time, "status": '
      '$status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", '
      '"request_query": "$args", "request_length": $request_length, "duration": $request_time, '
      '"method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": '
      '"$http_user_agent" }';

    access_log  /dev/stdout json if=$excluded_ua;

    sendfile        on;
    #tcp_nopush     on;
    server_tokens off;

    keepalive_timeout  65;

    #gzip  on;

    server {
	listen   5000;
	server_name  _;
	root /app;
	error_log    /dev/stderr;

        location /healthz {
             access_log off;
 	     return 200 "OK\n";
        }

	location / {
	    add_header X-Frame-Options SAMEORIGIN;
	    add_header X-Content-Type-Options nosniff;
	    add_header X-XSS-Protection 1;
	    add_header X-Content-Type-Options nosniff;
            add_header Strict-Transport-Security max-age=31536000;

            fastcgi_hide_header X-AspNet-Version;

	    index index.html index.htm default.aspx Default.aspx Index.html;
	    fastcgi_index Index.html;
	    fastcgi_pass 127.0.0.1:9000;
	    include /etc/nginx/fastcgi_params;
	}
    }
}

